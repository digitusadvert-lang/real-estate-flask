<!DOCTYPE html>
<html>
<head>
    <title>Downline Performance</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-value { font-size: 1.8em; font-weight: bold; margin: 10px 0; }
        .btn { padding: 8px 16px; border-radius: 5px; text-decoration: none; display: inline-block; }
        .btn-back { background: #6c757d; color: white; }
        .agent-header { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
        .agent-avatar { font-size: 50px; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; border-radius: 50%; background: #e9ecef; }
        .commission-rate { background: #e3f2fd; color: #1565c0; padding: 5px 10px; border-radius: 15px; font-weight: bold; }
        
        /* Fund calculation styles */
        .fund-calculation { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin: 20px 0; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .fund-item { 
            display: flex; 
            justify-content: space-between; 
            padding: 10px 0; 
            border-bottom: 1px solid #eee; 
        }
        .fund-item:last-child { 
            border-bottom: none; 
            font-weight: bold; 
            padding-top: 15px; 
        }
        .fund-label { color: #666; }
        .fund-value { font-weight: bold; color: #28a745; }
        .fund-breakdown { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 5px; 
            margin-top: 10px; 
        }
        
        @media (max-width: 768px) {
            .stats { grid-template-columns: repeat(2, 1fr); }
            .agent-header { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä Downline Performance</h1>
        <div style="margin-top: 10px;">
            <a href="/agent/my-downline" class="btn btn-back">‚Üê Back to Downline Network</a>
        </div>
    </div>
    
    {% if agent %}
    <div class="agent-header">
        <div class="agent-avatar">üë§</div>
        <div style="flex: 1;">
            <h2 style="margin: 0;">{{ agent.name }}</h2>
            <div style="color: #666; margin: 5px 0;">{{ agent.email }}</div>
            <div style="margin-top: 10px;">
                <span class="commission-rate">{{ agent.commission_percentage }} commission to you</span>
                <div style="font-size: 14px; color: #666; margin-top: 5px;">
                    Agent ID: #{{ agent.id }} | Joined: {{ agent.created_at }}
                </div>
            </div>
        </div>
        <div style="text-align: right;">
            <div style="font-size: 14px; color: #666;">Your Total Earnings</div>
            <div style="font-size: 28px; font-weight: bold; color: #28a745;">RM{{ "%.2f"|format(your_earnings|float) }}</div>
        </div>
    </div>
    
    {% if performance %}
    <div class="stats">
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Total Listings</div>
            <div class="stat-value" style="color: #007bff;">{{ performance.total_listings }}</div>
            <div style="font-size: 12px; color: #666;">
                {{ performance.approved_listings }} approved<br>
                {{ performance.rejected_listings }} rejected
            </div>
        </div>
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Total Sales Value</div>
            <div class="stat-value" style="color: #28a745;">RM{{ "%.0f"|format(performance.total_sales|float) }}</div>
            <div style="font-size: 12px; color: #666;">
                Avg: RM{{ "%.0f"|format(performance.avg_sale_price|float) }}
            </div>
        </div>
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Total Commission</div>
            <div class="stat-value" style="color: #6f42c1;">RM{{ "%.2f"|format(performance.total_commission|float) }}</div>
            <div style="font-size: 12px; color: #666;">
                Avg: RM{{ "%.2f"|format(performance.avg_commission|float) }}
            </div>
        </div>
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Approval Rate</div>
            <div class="stat-value" style="color: #fd7e14;">{{ "%.1f"|format(approval_rate|float) }}%</div>
            <div style="font-size: 12px; color: #666;">
                Rejection: {{ "%.1f"|format(rejection_rate|float) }}%
            </div>
        </div>
    </div>
    
    <!-- Replace the fund calculation section with this: -->
    <div class="fund-calculation">
        <h3>üí∞ Fund-Based Earnings Calculation</h3>
        <div style="margin-top: 15px;">
            <!-- Fund Allocation Breakdown -->
            <div class="fund-breakdown">
                <strong>Fund Calculation:</strong>
                <div class="fund-item">
                    <span class="fund-label">Total Approved Sales:</span>
                    <span class="fund-value">RM{{ "%.2f"|format(performance.approved_sales|float) }}</span>
                </div>
                
                {% for fund in funds %}
                <div class="fund-item">
                    <span class="fund-label">{{ fund.fund_name }} ({{ fund.percentage }}%):</span>
                    <span class="fund-value">RM{{ "%.2f"|format(fund.amount|float) }}</span>
                </div>
                {% endfor %}
                
                {% if your_earnings > 0 %}
                <div class="fund-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc;">
                    <span class="fund-label">Your Share as {% if agent.upline_id == session.get('user_id') %}Direct{% else %}Indirect{% endif %} Upline:</span>
                    <span class="fund-value">RM{{ "%.2f"|format(your_earnings|float) }}</span>
                </div>
                {% endif %}
            </div>
            
            <!-- Commission Flow -->
            <div style="margin-top: 20px;">
                <strong>Commission Distribution:</strong>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 10px;">
                    <div>
                        <div style="padding: 10px; background: #f0f7ff; border-radius: 5px;">
                            <div style="font-weight: bold; color: #1565c0;">Agent Commission:</div>
                            <div style="font-size: 18px; margin: 5px 0;">RM{{ "%.2f"|format(agent_gets|float) }}</div>
                            <div style="font-size: 12px; color: #666;">From Agent Fund</div>
                        </div>
                    </div>
                    <div>
                        <div style="padding: 10px; background: #e8f5e9; border-radius: 5px;">
                            <div style="font-weight: bold; color: #2e7d32;">Your Upline Commission:</div>
                            <div style="font-size: 18px; margin: 5px 0;">RM{{ "%.2f"|format(your_earnings|float) }}</div>
                            <div style="font-size: 12px; color: #666;">
                                {% if agent.upline_id == session.get('user_id') %}
                                    As Direct Upline ({{ agent.upline_fund_pct }}%)
                                {% else %}
                                    As Indirect Upline ({{ agent.upline2_fund_pct }}%)
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Explanation -->
            <div style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px; color: #666;">
                <strong>Calculation Formula:</strong><br>
                1. Commission Fund = {{ "%.1f"|format(agent.total_fund_pct) }}% √ó Approved Sales (RM{{ "%.0f"|format(performance.approved_sales|float) }})<br>
                2. Each party gets their percentage from the total fund
            </div>
        </div>
    </div>

    <!-- Monthly Performance Chart -->
    {% if monthly_data %}
    <div style="background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
        <h3>üìà Monthly Performance</h3>
        <div style="margin-top: 15px;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa;">
                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #dee2e6;">Month</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Listings</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Sales Value</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Commission</th>
                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #dee2e6;">Your Share</th>
                    </tr>
                </thead>
                <tbody>
                    {% for month in monthly_data %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">{{ month.month }}</td>
                        <td style="padding: 10px; text-align: right;">{{ month.listings }}</td>
                        <td style="padding: 10px; text-align: right;">RM{{ "%.0f"|format(month.sales_value|float) }}</td>
                        <td style="padding: 10px; text-align: right;">RM{{ "%.2f"|format(month.commission|float) }}</td>
                        <td style="padding: 10px; text-align: right; font-weight: bold; color: #28a745;">
                            RM{{ "%.2f"|format(month.your_share|float) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
    
    {% else %}
    <div style="padding: 40px; text-align: center; background: white; border-radius: 10px;">
        <h3 style="color: #666;">No Performance Data Yet</h3>
        <p style="color: #888;">This agent hasn't submitted any listings yet.</p>
    </div>
    {% endif %}
    
    {% else %}
    <div style="padding: 40px; text-align: center; background: white; border-radius: 10px;">
        <h3 style="color: #666;">Agent Not Found</h3>
        <p style="color: #888;">The agent you're looking for doesn't exist or you don't have access.</p>
        <a href="{{ url_for('agent_downline_network') }}" class="btn btn-back" style="margin-top: 20px;">Back to Downline Network</a>
    </div>
    {% endif %}
    
    <div style="margin-top: 30px;">
        <a href="/agent/my-downline" class="btn btn-back">‚Üê Back to Downline Network</a>
    </div>
</body>
</html>