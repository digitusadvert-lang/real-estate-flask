<!DOCTYPE html>
<html>
<head>
    <title>My Commissions & Earnings</title>
    <style>
        body { 
            font-family: Arial, sans-serif;
            margin: 20px; 
            background: #f5f5f5; 
        }
        .header { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .stats { 
            display: flex; 
            gap: 15px; 
            margin: 20px 0; 
            flex-wrap: wrap; 
        }
        .stat-card { 
            background: white; 
            padding: 15px; 
            border-radius: 8px; 
            flex: 1; 
            min-width: 120px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
            text-align: center; 
        }
        .stat-value { 
            font-size: 1.8em; 
            font-weight: bold; 
        }
        .filters { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .filter-group { 
            display: flex; 
            gap: 15px; 
            align-items: center; 
        }
        select, input { 
            padding: 8px 12px; 
            border: 1px solid #ddd; 
            border-radius: 5px; 
        }
        .btn { 
            padding: 8px 16px; 
            background: #007bff; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            text-decoration: none; 
            display: inline-block;
        }
        .btn:hover {
            background: #0056b3;
        }
        table { 
            width: 100%; 
            background: white; 
            border-radius: 10px; 
            overflow: hidden; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            margin: 20px 0; 
        }
        th, td { 
            padding: 12px 15px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        }
        th { 
            background: #2c3e50; 
            color: white; 
        }
        .status-badge { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
        }
        .status-approved { 
            background: #d4edda; 
            color: #155724; 
        }
        .status-pending { 
            background: #fff3cd; 
            color: #856404; 
        }
        .status-paid { 
            background: #cce5ff; 
            color: #004085; 
        }
        .payment-type { 
            padding: 4px 10px; 
            border-radius: 12px; 
            font-size: 12px; 
            font-weight: bold; 
        }
        .type-own { 
            background: #d4edda; 
            color: #155724; 
        }
        .type-upline { 
            background: #cce5ff; 
            color: #004085; 
        }
        .action-btn { 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            text-decoration: none; 
            margin-right: 5px; 
            color: white;
        }
        .btn-view { 
            background: #17a2b8; 
        }
        .btn-details { 
            background: #6f42c1; 
        }
        .empty-state { 
            text-align: center; 
            padding: 50px 20px; 
            background: white; 
            border-radius: 10px; 
            color: #666; 
        }
        .earning-amount {
            font-weight: bold;
        }
        .earning-amount.approved {
            color: #28a745;
        }
        .earning-amount.pending {
            color: #fd7e14;
        }
        .earning-amount.paid {
            color: #007bff;
        }
        .section-title {
            font-size: 1.2em;
            font-weight: bold;
            margin: 25px 0 15px 0;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }
        .page-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .page-btn:hover {
            background: #007bff;
            color: white;
        }
        .page-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .page-info {
            text-align: center;
            color: #666;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ My Commissions & Earnings</h1>
        <div>
            <a href="/agent/dashboard" class="btn">‚Üê Dashboard</a>
            <a href="/agent/submissions" class="btn" style="background: #28a745;">üìã My Submissions</a>
        </div>
    </div>
    
    <div class="stats">
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Total Earnings</div>
            <div class="stat-value" style="color: #28a745;">RM{{ "%.2f"|format(total_earnings|default(0)) }}</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Own: RM{{ "%.2f"|format(total_own_paid|default(0)) }}
            </div>
        </div>
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Approved</div>
            <div class="stat-value" style="color: #17a2b8;">RM{{ "%.2f"|format(total_approved|default(0)) }}</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                {{ total_count|default(0) }} sales
            </div>
        </div>
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Pending</div>
            <div class="stat-value" style="color: #fd7e14;">RM{{ "%.2f"|format(total_pending|default(0)) }}</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Awaiting payment
            </div>
        </div>
        <div class="stat-card">
            <div style="font-size: 14px; color: #666;">Total Payments</div>
            <div class="stat-value" style="color: #6f42c1;">{{ total_payments_count|default(0) }}</div>
            <div style="font-size: 12px; color: #888; margin-top: 5px;">
                Own: {{ own_payments_count|default(0) }}
            </div>
        </div>
    </div>
    
    <div class="filters">
        <h3>Filter Commissions</h3>
        <form method="GET" class="filter-group">
            <select name="status">
                <option value="all" {% if filter_status == 'all' %}selected{% endif %}>All Status ({{ total_count|default(0) }})</option>
                <option value="approved" {% if filter_status == 'approved' %}selected{% endif %}>Approved ({{ total_count|default(0) }})</option>
                <option value="pending" {% if filter_status == 'pending' %}selected{% endif %}>Pending ({{ pending_count|default(0) }})</option>
                <option value="paid" {% if filter_status == 'paid' %}selected{% endif %}>Paid</option>
            </select>
            
            <select name="payment_type">
                <option value="all" {% if filter_payment_type == 'all' %}selected{% endif %}>All Payments</option>
                <option value="own" {% if filter_payment_type == 'own' %}selected{% endif %}>Own Commissions</option>
                <option value="upline" {% if filter_payment_type == 'upline' %}selected{% endif %}>Upline Commissions</option>
            </select>
            
            <select name="sort_by">
                <option value="date_desc" {% if filter_sort_by == 'date_desc' %}selected{% endif %}>Date (Newest First)</option>
                <option value="date_asc" {% if filter_sort_by == 'date_asc' %}selected{% endif %}>Date (Oldest First)</option>
                <option value="amount_desc" {% if filter_sort_by == 'amount_desc' %}selected{% endif %}>Amount (High to Low)</option>
                <option value="amount_asc" {% if filter_sort_by == 'amount_asc' %}selected{% endif %}>Amount (Low to High)</option>
            </select>
            
            <input type="text" name="search" placeholder="Search by customer or property..." value="{{ filter_search }}">
            
            <button type="submit" class="btn">üîç Filter</button>
            <a href="/agent/commissions" class="btn" style="background: #6c757d;">Clear</a>
        </form>
    </div>
    
    <div class="section-title">Commissions List</div>
    
    {% if commissions_list and commissions_list|length > 0 %}
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Property</th>
                <th>Sale Price</th>
                <th>Commission</th>
                <th>Type</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for comm in commissions_list %}
            <tr>
                <td>#{{ comm.id }}</td>
                <td>
                    <strong>{{ comm.customer_name }}</strong>
                    {% if comm.customer_email %}
                    <br><small style="color: #666;">{{ comm.customer_email }}</small>
                    {% endif %}
                </td>
                <td>
                    {{ (comm.property_address or '')[:30] }}
                    {% if (comm.property_address or '')|length > 30 %}...{% endif %}
                    {% if comm.project_name %}
                    <br><small style="color: #666;">{{ comm.project_name }}</small>
                    {% endif %}
                </td>
                <td>RM{{ "%.2f"|format(comm.sale_price|default(0)) }}</td>
                <td>
                    <span class="earning-amount 
                        {% if comm.payment_status == 'paid' %}paid
                        {% elif comm.status == 'approved' %}approved
                        {% else %}pending{% endif %}">
                        RM{{ "%.2f"|format(comm.commission_amount|default(0)) }}
                    </span>
                </td>
                <td>
                    {% if comm.is_upline_payment %}
                    <span class="payment-type type-upline">Upline</span>
                    {% else %}
                    <span class="payment-type type-own">Own</span>
                    {% endif %}
                </td>
                <td>
                    {% if comm.payment_status == 'paid' %}
                    <span class="status-badge status-paid">Paid</span>
                    {% elif comm.status == 'approved' %}
                    <span class="status-badge status-approved">Approved</span>
                    {% else %}
                    <span class="status-badge status-pending">Pending</span>
                    {% endif %}
                </td>
                <td>
                    {% if comm.approved_at %}
                    {{ comm.approved_at[:10] }}
                    {% elif comm.created_at %}
                    {{ comm.created_at[:10] }}
                    {% endif %}
                </td>
                <td>
                    <a href="/agent/commission-details/{{ comm.id }}" class="action-btn btn-view">üëÅÔ∏è View</a>
                    <a href="/agent/submission/{{ comm.submission_id }}" class="action-btn btn-details">üìã Details</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    
    {% if total_pages|default(0) > 1 %}
    <div class="page-info">
        Showing page {{ current_page|default(1) }} of {{ total_pages|default(1) }}
    </div>
    <div class="pagination">
        {% if (current_page|default(1)) > 1 %}
        <a href="?page={{ current_page|default(1) - 1 }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_payment_type != 'all' %}&payment_type={{ filter_payment_type }}{% endif %}{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_sort_by != 'date_desc' %}&sort_by={{ filter_sort_by }}{% endif %}" 
           class="page-btn">‚Üê Previous</a>
        {% endif %}
        
        {% for page in range(1, total_pages|default(1) + 1) %}
            {% if page == current_page|default(1) %}
            <span class="page-btn active">{{ page }}</span>
            {% else %}
            <a href="?page={{ page }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_payment_type != 'all' %}&payment_type={{ filter_payment_type }}{% endif %}{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_sort_by != 'date_desc' %}&sort_by={{ filter_sort_by }}{% endif %}" 
               class="page-btn">{{ page }}</a>
            {% endif %}
        {% endfor %}
        
        {% if (current_page|default(1)) < (total_pages|default(1)) %}
        <a href="?page={{ current_page|default(1) + 1 }}{% if filter_status != 'all' %}&status={{ filter_status }}{% endif %}{% if filter_payment_type != 'all' %}&payment_type={{ filter_payment_type }}{% endif %}{% if filter_search %}&search={{ filter_search }}{% endif %}{% if filter_sort_by != 'date_desc' %}&sort_by={{ filter_sort_by }}{% endif %}" 
           class="page-btn">Next ‚Üí</a>
        {% endif %}
    </div>
    {% endif %}
    
    {% else %}
    <div class="empty-state">
        <h3>No commissions found</h3>
        <p>{{ empty_message|default('No commissions match your current filters. Try adjusting your search criteria.') }}</p>
        <a href="/agent/commissions" class="btn" style="background: #28a745; margin-top: 15px;">
            Clear Filters
        </a>
    </div>
    {% endif %}
    
    <div class="section-title">Recent Payments</div>
    
    {% if recent_payments and recent_payments|length > 0 %}
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Type</th>
                <th>Amount</th>
                <th>Customer</th>
                <th>Status</th>
                <th>Reference</th>
            </tr>
        </thead>
        <tbody>
            {% for payment in recent_payments %}
            <tr>
                <td>{{ payment.payment_date[:10] if payment.payment_date else 'N/A' }}</td>
                <td>
                    {% if payment.payment_type == 'Own' %}
                    <span class="payment-type type-own">Own</span>
                    {% else %}
                    <span class="payment-type type-upline">Upline</span>
                    {% endif %}
                </td>
                <td>
                    <span class="earning-amount paid">
                        RM{{ "%.2f"|format(payment.amount|default(0)) }}
                    </span>
                </td>
                <td>
                    {{ payment.customer_name or 'N/A' }}
                    {% if payment.selling_agent_name and payment.is_upline_payment %}
                    <br><small style="color: #666;">via {{ payment.selling_agent_name }}</small>
                    {% endif %}
                </td>
                <td>
                    {% if payment.payment_status == 'paid' %}
                    <span class="status-badge status-paid">Paid</span>
                    {% else %}
                    <span class="status-badge status-pending">{{ payment.payment_status|title }}</span>
                    {% endif %}
                </td>
                <td><code>{{ payment.reference or 'N/A' }}</code></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <h3>No recent payments</h3>
        <p>Payment records will appear here once commissions are paid.</p>
    </div>
    {% endif %}
    
    <div style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
        <p>Need help? Contact support for commission-related inquiries.</p>
    </div>
</body>
</html>